<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Hexa v10</title>
<style>
  :root{
    --bg:#0f1420; --tile-on:#3ec7c2; --tile-off:#2a3550;
    --ink:#e8eef8; --digit-ink:#e7f0ff;
    --gap: 12px;
    --tile-size: 88px;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
    display:flex; flex-direction:column; align-items:center;
    -webkit-tap-highlight-color: transparent;
  }
  h1{font-size:20px; font-weight:800; margin:12px 0 8px}
  #app{width:clamp(320px, 96vw, 820px); padding:0 10px; box-sizing:border-box; display:flex; flex-direction:column; align-items:center;}
  .hud{width:100%; display:flex; flex-direction:column; gap:6px; color:var(--ink); font-size:18px; font-weight:700}
  .row{display:flex; align-items:baseline; gap:10px}
  .row .label{white-space:nowrap}
  .value{display:block; width:100%; overflow-x:auto; white-space:nowrap; padding-bottom:2px; border-bottom:1px dashed rgba(231,240,255,0.2);}
  .grid{
    margin-top:14px;
    width:100%;
    display:grid;
    grid-template-columns: repeat(4, var(--tile-size));
    grid-auto-rows: var(--tile-size);
    gap: var(--gap);
    justify-content:center;
  }
  button.tile{
    width: var(--tile-size);
    height: var(--tile-size);
    border:none;
    border-radius:0px;
    background:var(--tile-off);
    color:var(--digit-ink);
    font-weight:800;
    font-size: clamp(16px, calc(var(--tile-size) * 0.42), 28px);
    display:flex; align-items:center; justify-content:center;
    user-select:none; touch-action:manipulation;
  }
  button.tile.on{ background:var(--tile-on); color:#0a1320; }
  .bar{width:100%; display:flex; justify-content:center; gap:var(--gap); flex-wrap:wrap; margin:14px 0 18px}
  .bar button{
    width: var(--tile-size);
    height: var(--tile-size);
    border:none; border-radius:0px;
    background:var(--tile-off); color:var(--digit-ink); font-weight:800;
    font-size: clamp(14px, calc(var(--tile-size) * 0.32), 22px);
  }
  .btn-on{ background:var(--tile-on)!important; color:#0a1320!important; }
</style>
</head>
<body>
  <h1>Hexa v10</h1>
  <div id="app">
    <div class="hud" id="hud">
      <div class="row">
        <span class="label">Step:</span>
        <div id="sValue" class="value"><span class="real">0</span></div>
      </div>
    </div>

    <div id="grid" class="grid" aria-label="4×8 dupla-hexa billentyűrács"></div>

    <div class="bar">
      <button id="n0" aria-pressed="false">N0</button>
      <button id="n1" aria-pressed="false">N1</button>
      <button id="n2" aria-pressed="false">N2</button>
      <button id="n3" aria-pressed="false">N3</button>
    </div>
  </div>

<script>
(()=>{
  const COLS=4, ROWS=8;
  const LABELS=[
    '0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F',
    '0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'
  ];
  const STORAGE_KEY='Hexa_v10_4x8_hexdup_combo16_counts';

  const root=document.documentElement;
  const app=document.getElementById('app');
  const hud=document.getElementById('hud');
  const gridEl=document.getElementById('grid');
  const elS=document.getElementById('sValue');
  const btns=[ 'n0','n1','n2','n3' ].map(id=>document.getElementById(id));
  let activeButtons=[false,false,false,false];
  let viewIndex=0;

  function emptyMatrix(){ return Array.from({length:ROWS},()=>Array(COLS).fill(false)); }
  function emptyCounts(){ return Array.from({length:ROWS},()=>Array.from({length:COLS},()=>({on:0, off:0}))); }
  const defaultBoardState = ()=>({ matrix: emptyMatrix(), step: "0", counts: emptyCounts() });
  let boardsState = Array.from({length:16}, defaultBoardState);

  // Big-int helpers (unsigned inc)
  const stripZeros = (s)=>{ let t=(s||'0').replace(/^0+(?=\\d)/, ''); return t===''?'0':t; };
  const addAbs = (a,b)=>{ a=stripZeros(a); b=stripZeros(b);
    let res='',carry=0,i=a.length-1,j=b.length-1;
    while(i>=0||j>=0||carry){ const da=i>=0?a.charCodeAt(i)-48:0; const db=j>=0?b.charCodeAt(j)-48:0;
      const s=da+db+carry; res=(s%10)+res; carry=(s/10)|0; i--; j--; }
    return stripZeros(res);
  };
  const incUnsigned = (A)=> stripZeros(addAbs(stripZeros(A), '1'));

  function renderValue(el, v){
    el.innerHTML='<span class="real">'+v+'</span>';
    requestAnimationFrame(()=>{ el.scrollLeft=el.scrollWidth; });
  }
  function syncHUD(){
    const b=boardsState[viewIndex];
    renderValue(elS, b.step);
    saveState();
  }
  function maskFromButtons(){
    return (activeButtons[0]?1:0) | (activeButtons[1]?2:0) | (activeButtons[2]?4:0) | (activeButtons[3]?8:0);
  }
  function renderButtons(){
    btns.forEach((btn,i)=>{
      const on=!!activeButtons[i];
      btn.classList.toggle('btn-on', on);
      btn.setAttribute('aria-pressed', String(on));
    });
  }

  function toggleCell(r,c,btn){
    const b=boardsState[viewIndex];
    const wasOn=b.matrix[r][c];
    b.matrix[r][c]=!wasOn;
    b.step=incUnsigned(b.step);
    // per-tile counters
    const cnt=b.counts[r][c];
    if (wasOn){ cnt.off++; } else { cnt.on++; }
    btn.classList.toggle('on', b.matrix[r][c]);
    btn.setAttribute('aria-pressed', String(b.matrix[r][c]));
    btn.title = `On: ${cnt.on} • Off: ${cnt.off}`;
    syncHUD();
  }

  function buildGrid(){
    gridEl.innerHTML='';
    const b=boardsState[viewIndex];
    for(let i=0;i<ROWS*COLS;i++){
      const r=(i/ COLS)|0, c=i % COLS;
      const key=document.createElement('button');
      key.className='tile'+(b.matrix[r][c]?' on':'');
      key.textContent = LABELS[i] || '';
      key.setAttribute('aria-pressed', String(!!b.matrix[r][c]));
      const cnt=b.counts[r][c];
      key.title = `On: ${cnt.on} • Off: ${cnt.off}`;
      key.addEventListener('click', ()=>{ toggleCell(r,c,key); });
      key.addEventListener('touchend', (e)=>{ e.preventDefault(); toggleCell(r,c,key); }, {passive:false});
      gridEl.appendChild(key);
    }
  }

  function pressButton(i){
    activeButtons[i]=!activeButtons[i];
    renderButtons();
    viewIndex=maskFromButtons();
    saveState();
    buildGrid();
    syncHUD();
    // Stabil autofit: várjuk meg, hogy a DOM tényleg felépüljön
    autoFit();
    requestAnimationFrame(()=>autoFit());
    setTimeout(autoFit, 100);
  }
  btns.forEach((b,i)=>{
    b.addEventListener('click', (e)=>{ e.preventDefault(); pressButton(i); });
    b.addEventListener('touchend', (e)=>{ e.preventDefault(); pressButton(i); }, {passive:false});
  });

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({boardsState, activeButtons, viewIndex})); }catch(e){}
  }
  function loadState(){
    try{
      const s=localStorage.getItem(STORAGE_KEY);
      if(s){
        const st=JSON.parse(s);
        if(st && Array.isArray(st.boardsState) && st.boardsState.length===16){
          boardsState = st.boardsState.map(b=>{
            if(!b || !b.matrix) return defaultBoardState();
            if(typeof b.step!=='string') b.step='0';
            if(!b.counts) b.counts = emptyCounts();
            return b;
          });
          if(Array.isArray(st.activeButtons) && st.activeButtons.length===4) activeButtons = st.activeButtons.map(Boolean);
          if(typeof st.viewIndex==='number') viewIndex = Math.max(0, Math.min(15, st.viewIndex));
          return true;
        }
      }
    }catch(e){ localStorage.removeItem(STORAGE_KEY); }
    return false;
  }

  // --- Adaptive sizing (DOM version) ---
  function autoFit(){
    const outer=18;
    const h1=document.querySelector('h1');
    const bar=document.querySelector('.bar');
    const h1H=h1?h1.getBoundingClientRect().height:0;
    const hudH=hud?hud.getBoundingClientRect().height:0;
    const barH=bar?bar.getBoundingClientRect().height:0;
    const safetyY=18;

    const maxW=Math.max(320, window.innerWidth - outer*2);
    const maxH=Math.max(260, window.innerHeight - (h1H+hudH+barH+safetyY+outer*2));

    let gap = Math.round(Math.max(10, Math.min(18, Math.min(maxW,maxH)*0.025)));
    root.style.setProperty('--gap', gap+'px');

    const sizeFromW = Math.floor((maxW - (gap*(COLS+1))) / COLS);
    const sizeFromH = Math.floor((maxH - (gap*(ROWS+1))) / ROWS);

    const MAX_TILE = Math.min(96, Math.floor(window.innerWidth/5));
    const tile = Math.min(MAX_TILE, Math.max(24, Math.min(sizeFromW, sizeFromH)));

    root.style.setProperty('--tile-size', tile+'px');

    const cssW = COLS*(tile+gap)+gap;
    app.style.width = Math.min(Math.max(cssW, 320), Math.min(window.innerWidth-outer*2, 820)) + 'px';
  }

  window.addEventListener('resize', ()=>{ autoFit(); setTimeout(autoFit, 50); });
  window.addEventListener('orientationchange', ()=>{ autoFit(); setTimeout(autoFit, 100); });

  if(!loadState()){ boardsState = Array.from({length:16}, defaultBoardState); }
  renderButtons();
  buildGrid();
  syncHUD();
  autoFit();
})();
</script>
</body>
</html>
